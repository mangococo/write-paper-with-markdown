---
title: "基于LoRa的饮水机水量无线监测送水系统设计"
output:
  word_document:
    reference_doc: ./template/template.docx
    path: /export/基于LoRa的饮水机水量无线监测送水系统设计.docx
---

---
fignos-cleveref: TRUE
fignos-plus-name: 图

tablenos-cleveref: TRUE
tablenos-plus-name: 表
...

# 摘 要
在低功耗广域网（Low Power Wide Area Network，LPWAN）产生
之前，似乎远距离和低功耗只能二选其一，无线连接技术也不再满足于近距离通信，正在向着距离更远、覆盖更广的方向发展。当 LPWAN 技术陆续推广采用之后，通信网络规划设计人员可将远距离与低功耗两者兼顾，最大程度的实现高效通信传输，同时，大大降低中继的成本。LoRa 作为物联网通信技术的一种可以很大程度的提高系统的传输距离，降低系统功耗。该系统集成了单片机，重量传感器、LoRa 模块，软件平台。本论文完成了集成了传感终端的监测系统的硬件实现。采用重量传感器作为终端的微控制器控制传感器模块进行有规律的数据采集，将数据存储并通过 LoRa 传输给数据中心。LoRa 作为通信模块将数据发送到应用服务器，然后数据被保存，分析。此外，在系设计中包含一个易于使用的APP。
LORA 技术的核心在于数据的传输，首先对 LORA 数据包进行全面的定义及解析，然后由通信规约实现的业务逻辑引申出唤醒机制在整个系统中数据传递的作用，其次对智能送水饮水机送水系统中各模块的设计思路进行详细描述与验证，且通过对 SX1278 无线芯片 LORA 技术的研究，极大的扩充和填补了目前嵌入式无线通信领域的通信方式，为了提高饮水机送水效率。经过参考大量相关的国内外文献，并结合市场实际研发与应用的情况,在综合分析物联网关键技术的基础上，延伸出 SX1278 无线射频芯片的 LORA 技术。也为无线水量检测送水系统的发展带来了跨越式的机会。


关键词：LoRa; SX1278; 智能饮水机;

# Abstract
Before the generation of Low Power Wide Area Network (LPWAN), it seems that long distance and low power consumption can only be chosen one by one. The wireless connection technology is no longer satisfied with short-range communication, and is moving farther and covering. A broader direction of development. After the adoption of LPWAN technology, communication network planners can combine both long-distance and low-power consumption to maximize efficient communication and reduce the cost of relays. As a kind of IoT communication technology, LoRa can greatly improve the transmission distance of the system and reduce the system power consumption. The system integrates a single chip microcomputer, weight sensor, LoRa module, and software platform. This paper completed the hardware implementation of the monitoring system integrated with the sensing terminal. The weight sensor is used as the terminal's microcontroller control sensor module for regular data acquisition, and the data is stored and transmitted to the data center through LoRa. LoRa sends the data to the application server as a communication module, and the data is saved and analyzed. In addition, an easy-to-use app is included in the design.
The core of LORA technology lies in the transmission of data. Firstly, the LORA data package is fully defined and parsed. Then the business logic realized by the communication protocol extends the role of the wake-up mechanism in the whole system, and then the intelligent water dispenser water delivery system. The design ideas of each module are described and verified in detail, and through the research on the SLO1278 wireless chip LORA technology, the communication method in the field of embedded wireless communication is greatly expanded and filled in order to improve the water delivery efficiency of the water dispenser. After referring to a large number of relevant domestic and foreign literatures, combined with the actual development and application of the market, based on the comprehensive analysis of the key technologies of the Internet of Things, the LORA technology of the SX1278 wireless RF chip is extended. It also brings leaps and bounds to the development of wireless water detection and water supply systems.

Key words: LoRa; SX1278; intelligent water dispenser;

# 引言
20世纪90年代，麻省理工学院的 Kevin Ashton提出了物联网的概念，并作如下定义：所有的事物都是通过传感器，比如无线射频识别(radio frequency identification，RFID)连接到互联网，实现智能化管理。[@xiaojiang2010services]物联网可以实现物理世界与网络空间的互联与整合，它代表了未来网络化的趋势，引领信息产业革命的第３次浪潮。信息网络已广泛地应用于日常生活的各个方面，提供了很多设备之间的互联，比如娱乐设备、家庭应用、飞机、个人电脑和各种传感器设备等[@ma2011internet]。饮水机在家庭、办公场所市场潜力巨大，然而传统的上电后独立工作的饮水机已经不能满足信息时代的需求，智能化和网络化是其发展的必然趋势。对于只能饮水机的研究，其他研究者已经针对“如何让饮水机功能更多元化”做出了足够多的付出与贡献。[@夏鲲2018基于物联网的智能饮水机系统设计与实现]

但是这些研究无不忽略了饮水机带给用户的困扰不仅仅是功能的单一，更是每次练习饮用水公司送水的烦恼。而本系统，针对传统饮水机智能化和网络化应用方面的不足，本系统基于物联网的基本架构，基于LoRa无线通信协议，辅以互联网交互，通过手机app与微信扫码技术与后台数据中心服务器进行数据交互，实现了对饮水机、用户、饮用水配送公司、服务器站点管理人员等数据的统一管理和维护。从而一定程度上地免去用户在购买，配送引用绶时的繁琐。

## 课题研究的背景及来源
生活用水一直是人们所关注的重要课题，而饮用水更是重中之重。目前，下置式饮水机由于其美观及卫生较上置式饮水机好，因此下置式饮水机越来越受人们欢迎。然而，下置式饮水机有一个体验不好的问题是无法直观地看到桶装水中的水量，当桶装水中缺水时用户也无法第一时间感知。如此时没有多余储备的桶装水可以更换，用户将面临没有水喝的问题，体验十分不好。而对于大多数居民而言，家庭饮用水主要还是以饮水机加送水公司的形式，而送水对于大多数居民而言仍是一大烦恼。在这样的大背景下，如何提高饮水机送水效率的重要性显得愈发重要。近些年来，随着城市的快速发展及人口大规模迁移，城市高层住宅规模也越来越大，对送水公司的需求也急剧增加，同时也造成送水工作的难度不断加大，同时增加了不必要的人力资源浪费。如何应对激增的用户数量，对庞大且分散的用户群提供进行及时、准确、有效的送水工作成为饮用水企业迫切需要解决的问题。传统的“用户呼叫要求送水--饮用水公司送水”的商业模式需要用户在需要时呼叫客服，又增加了用户的等待时间，效率非常低下，劳动强度大，也易因交通问题引起相当多不必要的纠纷。在这种情况下，传统的送水方式已经不能适应社会需求的发展，自动检测水量无线送水系统成为饮用水企业未来发展的必然趋势，然而除了检测水量功能，如何将用户需要饮用水的需求数据快速准确地传送给饮用水管理者，同样也变得十分的重要，从而顺应物联网发展的无线检测饮水机水量送水技术的发展应运而生[@赵静2016lora]。

饮水机水量无线监测送水系统是一种不需要用户主动请求送水服务就可以完成自动检测用户饮水机剩余水量，提供及时送水服务的智能化送水服务系统。该系统主要运用传感器技术、信号处理技术、通信技术、计算机技术等现代化技术，实现了数据采集、数据处理、数据传输、数据管理等内容。而水量无线监测系统根据通信媒介的不同可分为有线监测送水和无线监测送水两种方式，有线监测采用M-BUS、485 等总线方式，抄读快速，技术成熟，但有线通信需敷设大量长距离线路，数据传输稳定性会下降，且线路容易遭受到人为的破坏，造成故障点筛查难度增加[@赵静2016lora]。无线通信方式目前主要采用 GSM、GPRS、WIFI、ZigBee、LORA 等通信技术，自适应性极强，采用无线自动组网或通过无线通信公网的方式，安装、调试便捷，无需大量线路施工，大大降低线路成本和浪费，且易于维护，性能稳定，由于没有长距离敷设线路，相比于有线方式，其故障筛查更为精准与简便，更符合城镇化建设的发展需要[@戴国华2016nb]。

## 无线发射式水量无线监测送水方式
现代无线通信技术的迅猛发展为饮水机水量无线监测送水方式提供了更为先进的手段，即在饮水机内部集成无线发射模块，根据其应用的特殊性，此类无线发射模块具备稳定的低功耗和长距离等优点。水量无线监测智能送水方式的应用，大大降低了施工和维护成本，但就表体而言实际成本略有增加。由于无线方式涉运营商通信频点和带宽的使用，所以需缴纳一定的费用，且民用通信产品对无线发射信号也会存在一定的同频干扰等问题。即便无线方式存在一些弊端，但就其优势而言则更为明显。随着 LORA、NB-IOT 等技术的突破，世界各国正大力建设低功耗广域网的基础骨干网，使得基于物联网的饮水机水量无线监测送水越来越受到青睐[@戴国华2016nb]。

# LORA 技术基础
## LORA 概述
LORA 技术是基于 SEMTECH 公司所研发的无线射频芯片，其采用线性调频扩频 LORATM 调制技术，用于将传感器采集的各类信号（例如声音、压力、磁场等）通过无线远距离发送，也可用于接收控制中心或手持自检预置器的命令。在低功耗方面，LORA 和FSK 调制都属于超低功耗的无线传输技术，但LORA 技术在通信距离和抗干扰能力方面，优势更为明显。其特殊的扩频技术和容错能力能在同一的频率下完美的接收接收来自不同频率终端的信号，避免了目前无线通信领域同频干扰的瓶颈，也使得嵌入式无线通信领域的产业局面也发生了彻底的改变。

## LORAWAN 及其网络结构
LORAWAN 是基于LORA技术而制定的网络协议，它可以为使用电池供电的无线设备提供区域、国家或全球的网络连接，对嵌入式应用的研发具有强大的兼容性和可扩展性，能实现无缝连接。由于 LORAWAN 搭建了一整套的基础协议框架，使得全球从事物联网领域的厂家可以在此基础上进行产品的研发、生产、制造，且性价比相对其他网络更有优势。

LORAWAN 采用星型拓扑结构，支持区域级、城市级、省级、国家级等不同大小的网络规模，在一定规模的网络架构中，网关的数量往往会在关键节点大量部署，实现应用端和服务端中继路由、透明转发的功能，以达到全网覆盖的目的。

应用端设备调制解调出适用于LORAWAN的LORATM或 FSK 信号，与网关进行通信与数据传输，网关则以GPRS、3G、4G 等网络与后台服务端进行通信与数据传输。LORAWAN 中设备间的通信支持不同的信道频率，LORAWAN 网络传输速率范围在 0.3kbps~50kbps 之间，即便设备在同一频率，如果使用不同速率来进行通信，也不存在同频干扰的问题。自适应数据速率（ADR，Adaptive Data Rate）策略，可以改变实际的数据速率以确保可靠的数据包传送，优化网络性能和终端节点容量规模。ADR 策略科适应网络基础设施的变化，支持变化的路劲损耗。为使应用端设备的电池寿命和总体网络容量达到最大化，LORAWAN 通过 ADR 实现对每个应用端节点的数据速率和 RF 输出功率进行管理[@裴凤芹2013无线远传抄表系统关键技术;@原羿2004基于]。

![LORAWAN 网络架构图](https://i.loli.net/2018/09/28/5badca7c264f7.jpg){#fig:demo_lora_net_build tag="4.1"}

- 终端节点（含传感器）
LORAWAN 网络中的终端无线模块采用 LORATM（线性扩频调制技术）或FSK（频移键控调制技术）来实现通信与数据传输，且适用于通信网络中的七层协议，LORA 技术的稳定性同时也为低功耗和远距离提供了重要保证。
- 网关/集中器
网关分布在 LORAWAN 的特定位置，其信号范围覆盖所有终端节点，一个终端节点发射的信号和数据可能被多个网关接收并处理，网关再将数据通过 TCP/IP协议发送至上行汇聚节点，由汇聚节点统一判断数据和信息的有效性[@裴凤芹2013无线远传抄表系统关键技术]。网关的路由路径可以根据信号的变化产生变化，实现路由和中继转发的功能。
- 网络服务器
网络服务器作为网关和应用服务器之间的桥梁，实现上行链路之间的底层数据包和控制逻辑的处理，以保障上行通信的安全性与可靠性。
- 应用服务器
应用服务器对数据进行最终的整合、分析与控制，以直观界面的形式将终端节点的状态、运行情况、控制情况等重要参数予以呈现，并根据管理者需要对终端节点进行参数调整等。许多现存的网络都是网状结构，在网状网络中，各个终端节点可以转发其他节点的信息，充当路由的功能，这样提高了网络通信距离和通信范围。但缺点是增加了系统的复杂性，降低了网络容量，并且为了接收和处理这些信息，电池的消耗量非常大，而这些信息中只有很少的部分和这个节点有关，节点电池消耗在处理与自己无关的信息上。LORAWAN 采用远距离星型结构，优势在于不仅能实现远距离连接，而且能够很好的保护电池寿命。

终端节点并不与特定的网关连接，相反，由终端发出的数据通常可以被多个网关接收，每个网关再通过 TCP/IP 网络（可以是 GPRS、WIFI、卫星或以太网）将接收到的数据包发往云网络服务器，服务器将通过时间表来提出多个网关发来的重复数据，如果一个终端是移动的，那么此功能可以保证数据的正常收发，并且可以侦测到静止终端的非正常移动，保证了资产安全，除此之外，服务器还会执行安全检查和自适应数据速率等，将智能性和复杂性转移到服务器，使设备得到简化[@裴凤芹2013无线远传抄表系统关键技术]。

## LORA 数据包结构
LORA 调制解调器具有两种数据包模式：显示模式和隐式模式。区别在于，显示数据包模式有一个包含字节数、编码率以及数据包是否启用 CRC 校验等信息的报头。LORA 数据包(如{@fig:loradatagram} )主要包含前导码、可选报头、数据有效负载和负载的 CRC校验。

![LORA 数据包结构](https://i.loli.net/2018/09/25/5ba9d0045b28e.jpg){#fig:loradatagram tag="4.2"}

1．前导码（Preamble）
前导码是位于数据包起始处的一组 bit 组，前导码用于保持接收机与接收数据流之间的同步。前导码有长前导码和短前导码两种模式，其长度是一个可通过程序进行设置的变量，默认长度为 12 个符号，设置范围在 6 到 65536 之间。在接收数据量较大或者网络同步性要求较高的应用中，可通过缩短前导码的长度，缩短终端接收的占空比。前导码最小允许长度就可以满足通信要求，其可变长度主要应用在唤醒设备及兼容其他网络设备的过程中。终端会定期检测发射机信号的前导码，接收机只有检测到前导码长度等于自身设定的长度时才会开始接收数据，并向CPU发出中断或者将中断寄存器置1，以供CPU定时查询该寄存器，否则保持休眠状态。

2．报头（Header）
通过对寄存器的设定，可以选择两种不同的报头。显式报头是默认的操作模式，报头主要包含有效负载的相关信息，包括有效负载字节数、前向纠错码率和
是否打开 16  位负载  CRC  校验。如果显式报头的相关信息在开发时已确定，则可以选择隐式报头来缩短发送时间，同时需要为接收机和发射机软件写入已知的有效负载长度、前向错码率和  CRC。

3．有效负载（payload）
有效负载实际上就是数据段，即你要发或者要收的数据。在实际传输中，指令不同，返回数据不同，所以数据包有效负载长度并不是固定的。显式模式下长度在报头中指定，隐式模式下长度可通过寄存器来决定。LORA 数据包中采用了自动纠正传输误码的前向纠错编码技术，数据包中增加了冗余信息，允许接收方检测可能出现在信息任何地方的有限个差错，并且通常可以纠正这些差错而不用重传，从而实现数据包在传输过程中的自我修复，但前向纠错编码技术需要消耗固定的带宽。该项技术多用于大型组网中信号远距离传输或复杂路径衰减时体现出优异的纠错功能。注入前向纠错编码的 LORA 数据包将每一比特时间划分为众多码片，划分的范围为 64-4096 码片/比特（ZigBee 仅能划分的范围为 10-12 码片/比特）[@裴凤芹2013无线远传抄表系统关键技术;@原羿2004基于]，所以即便调制噪声较大，LORA 也能完美地进行应对。

## LORA 唤醒方式
在星型的网络结构中，为了延长电池寿命，终端节点通常需要唤醒来进行数据传输。唤醒方式不同，数据的传输方式也不同，可分为以下两种：

- 主动唤醒
终端利用  MCU  内部定时器或者  RTC  时钟定时将设备唤醒，唤醒后终端主动将收集到的数据上传到服务器，随后再次进入休眠态。此种方式的唤醒适用于数据更新周期较长的设备，且不需要服务器突发访问该设备。

- 空中唤醒
此种方式适用于需要突发试访问的设备。终端设备和服务器并没有约定某个时刻彼此通信，服务器随时都可能读取终端中的数据。在  LORA  通信中，空中唤醒过程如下：若终端休眠时间为  T  秒，那就意味着终端每  T  秒主动唤醒一次，但是并不是为了主动上传数据，而是主动检测是否有设备发送前导码。当服务器需要和某个终端链接，会通过网关发送持续  T  秒的前导码，以覆盖终端的休眠周期，确保终端主动唤醒后可以检测到前导码。若终端唤醒后检测到前导码，则进入正常状态，立即接收处理数据，若主动唤醒后没有检测到前导码，则立即进入休眠态，以节省电量。

本设计是基于 LORA 技术在智能检测水量送水服务上的应用，而数据交互往往是只有当水量低于阈值时才会触发，且往往对于不同的用户而言其触发时机也不同，所以应采用主动唤醒的方式（依靠传感器触发脉冲唤醒射频模块）。

## LORA 空中传输时间
在空中唤醒时，需要连续发送覆盖接收设备休眠周期的前导码，前导码传输时间的计算对准确唤醒设备至关重要，所以前导码的空中传输时间将在计算空中传输时间时单独介绍。在设备初始化时，用户可设置的关键参数包括信号带宽($BW$)、扩频因子($SF$)、编码率($CR$)，利用公式 ({@eq:L_s} ) 计算 LORA 符号速率：

$$
L_s=\frac {2^{sf}} {BW}
$$ {#eq:L_s tag="4.1"}

前导码的传输时间通过公式 ({@eq:T_p} ) 来计算:
$$
T_p = ({N_p}+4.25)L_s
$$ {#eq:T_p tag="4.2"}

$N_p$表示已设定的前导码长度，其值可通过编程来确定。当已知休眠时间$T_p$，就可通过公式({@eq:T_p} )来确定需要设定前导码的个数。除了前导码，空中传输时间还包括报头和有效负载，其符号个数 $N_d$可通过公式 ({@eq:N_d} ) 来计算：

$$
N_d=8+max(ceil[ \frac {(8PL-4SF+28=16CRC-201H)}{4(SF-2DE)}](CE+4), 0)
$$ {#eq:N_d tag="4.3"}

公式中符号含义如下：
- $PL$  表示有效负载的字节数(范围在1到 255)
- $SF$  表示扩频因子（范围在 6 到 12）
- $IH=0$  表示使能报头；$IH=1$  表示禁用报头
- 开启低数据速率优化时,$DE=1$；否则 $DE=0$
- $CR$表示编码率(范围在 1 到 4)报头和有效负载的空中传输时间 $T_d$为：

$$
T_d=N_d \times L_s
$$ {#eq:T_d tag="4.4"}

数据包空中传输时间即为公式 ({@eq:N_d} ) 和公式 ({@eq:L_s} ) 的和：

$$
T_{packet} = T_p + T_d
$$ {#eq:T_packet  tag="4.5"}

## LORA 跳频
跳频扩频技术  FHSS(Frequency-Hopping  Spread  Spectrum)，是指收发双方在同时且同步的情况下，按照事先约好的跳频图案跳转通信频率。无线通信的健壮性主要来自外部干扰和多经衰退这两方面的挑战：外部干扰主要来自生活中经常使用无线通信如手机、无线路由、电台、遥控玩具等；多经衰退比较复杂，分析其全部影响因素几乎不可能，在实际环境中墙壁、门、树木、建筑物以及走动的人都可能造成信号的反射，所以收发双方除了无线信号直线传播路径外，还存在着多重反射路径，这些信号混合后可能造成很大的干扰[@米沃奇2016n]。解决外部干扰和多径反射的措施就是跳频技术，通过跳转通信频率用以规避某频段的干扰和信号反射。

LORA  跳频原理为：跳频发射和接收都始于信道 0。发射机将前导码和报头首先在信道 0 发送，前导码和报头发送完成后产生第一次跳频中断信号，MCU 响应中断，按照事先约定的频率跳转到信道 1，完成第一次跳变，跳转的同时信道计数器开始计数，计满一个跳变周期时，发出跳频中断，MCU  响应中断跳转到信道 2，再次重复上述过程。接收机接收从信道 0 开始，有效前导码和报头接收完成后，同样执行发射机的跳频流程。

信道驻留时间为单个符号发送时间的整数倍，可通过寄存器设定，且必须大于完成跳频所需的时间，这样数据才能在每个信道剩余时间发送。{@fig:lora_jump}为 LORA 跳频流程，当前导码和报头首先在信道 0  发送和接收完成后才进行跳频，有效负载则在多个信道内被分段发送接收。

![LORA 跳频流程](https://i.loli.net/2018/09/28/5badcb3169fed.jpg){#fig:lora_jump tag="4.3"}

# 系统总体架构
物联网可分为感知层、网络层和应用层3个层次。底层是感知层，主要用于物理世界中物体信息的感知、采集、汇聚和识别，包括RFID标签和读写器、全球定位系统（global positioning system，GPS）、传感器等，大量的底层结构按照系统需要合理的分布在物理空间中，大部分底层结构都必须同时具有路由和信息采集的双重功能；第2层是网络层，用于传输和处理感知层获得的信息和数据，并为应用层提供可靠的通信和处理支持；顶层是程序应用层，用于智能化的处理数据，各种类型的数据聚合，交互显示等, 如{@fig:lora_connect} 所示网络连接结构。[@zhang2011security;@胡向东2010一种改进的物联网感知层簇维护优化算法]。

![LoRaWAN网络连接框架](https://i.loli.net/2018/09/28/5badcb6220297.jpg){#fig:lora_connect tag="5.1"}

依照上述思想,基于LoRa的饮水机水量无线监测送水系统的设计如{@fig:sys_design} 所示，分为3个层次。

1. 第一层，采集层。采集模块是整个系统的最基础模块，也是最重要的数据来源。采集模块即包含用于监测采集水量信息的重量传感器，用于LoRa通信的LoRa射频模块和LoRa网关；也包含了用户终端app，用户所选择的预约时间也是极为重要的数据源。采集过程，由重量传感器监测、收集饮水机水量信息，交给微处理模块进行简单判定（仅为简单的比较运算）后经由LoRa射频模块，LoRa网关，广域网发送至应用服务器。
2. 第二层，服务器层。即应用服务器，其主要作用是云存储、计算、处理由采集层所提交的数据。应用服务器会对采集层说提交的监测水量进行判别，并根据用户以往所选择的预约送水时段进行计算，由此为用户推荐更符合用户需求，更加人性化的服务。
3. 第三层，终端层。主要为用户群与用户移动端app。移动app是用户与服务进行交互的有限的途径之一，当用户的饮水机水量告竭时，服务器会收到由LoRa发送的剩余水量信息，服务器对这些信息进行处理后，向用户终端发送“邀请预约送水服务”的推送。而服务器会收集用户的反馈（用户对于推送的响应时间，用户选择的预约时间，哪怕是用户未作相应……），进而通过这些数据为用户提供更加符合用户习惯的服务。

![系统的设计总图](https://i.loli.net/2018/09/28/5badca7c264f7.jpg){#fig:sys_design tag="5.2"}

本系统所设计的基于物联网的智能送水饮水机系统的感知层主要为重量传感器，用于实现检测饮水机剩余水量的功能；网络层主要为LoRa、TCP/IP、HTTP等，，LoRa模块作为数据采集点向LoRa网管上行由重量传感器采集的信息，而LoRa网管通过接入广域网与数据服器进行交互；完成底层和程序应用层之间的远距离数据和信息传输；程序应用层主要为MySQL数据库和服务器站点等，将从底层和网络层传输的大数据进行整合、处理，具有强大的通信和存储功能。最后，用户终端app以主观行为影响和控制整个智能送水饮水机系统，从而实现物与物、人与物、物与人之间信息的互联互通。

工作流程如{@fig:sys_service_flow} 所示，当采集系统判定饮水机剩余水量低于阈值时，便会将用户饮水机水桶中的剩余水量（根据水桶重量计算得到）通过LoRa模块发送至LoRa网关。经过LoRa网管将该数据通过广域网发送至应用服务器。服务器分析数据并向用户发送“建议性响应”。

![智能送水系统业务流程](https://i.loli.net/2018/10/05/5bb781224eb10.jpg){#fig:sys_service_flow tag="5.3"}

## LoRa监测送水系统部署

如{@fig:lora_gateway_communication} 所示，将一定范围（以LoRa所支持的城市无线传输距离为依据）内的社区划分为一个区域，进而为该区域设置一个LoRa网关。

![区域LoRa模块与LoRa网关进行数据传输](https://i.loli.net/2018/09/28/5badcbe2b006b.png){#fig:lora_gateway_communication tag="5.4"}

为了实现万物互联，需要一个服务器处理经由loRa的上行数据，而由于LoRa网关可以接入广域网，所以我们只需要为某一范围（以城市或地区为宜）的区域设定一个网络服务器，设计如{@fig:demo02} 所示。

![区域LoRa模块与LoRa网关进行数据传输](https://i.loli.net/2018/09/28/5badcc04b9421.png){#fig:demo02 tag="5.5"}

## 智能送水饮水机采集层设计方案

感知层及数据收集层工作主要由称重传感器完成，称重传感器是一种将质量信号转变为可测量的电信号输出的装置。本系统的传感器模块采用数字式称重传感器。数字式传感器系统是在传统电阻应变式传感器基础上，结合现代微电子技术、微型计算机技术集成而发展起来的一种新型电子称重传感器。数字式称重传感器是由模拟传感器（电阻应变式）和数字化转换模块两部分组成的。数字模块由高度集成化的电子电路，采用SMT表面贴装技术制成，主要包括放大器、A/D转换器、微处理器（CPU）、存储器、接口电路（RS485）和数字化温度传感器等。

# 硬件设计

## 传感器
数字式称重传感器具有以下特点：

- 可靠性高,抗干扰能力强，防雷性能好
- 模拟传感器由仪表供电，其电桥的激励电压就等于外界仪表的供电。在工业现场，仪表与传感器之间易受强电干扰和浪涌影响，会造成数据不稳，甚至瞬时烧毁传感器。
- 数字传感器采用全密封不锈钢激光焊接技术，内充氦气保护内部电路可靠工作，防护等级达到IP68。增加了各种保护电路和防雷击设计，对仪表提供的电源先进行处理，稳压后再用于电桥的激励，就消除了来自电源和雷电的浪涌干扰，使得传感器输出稳定的信号，保证了传感器的正常工作。
- 不间断工作 数字称重系统能保障生产的连续性，实现不间断工作，仪表不但时刻监测着各个数字传感器的工作状况，而且在发现某个传感器故障时，仪表可以自动启动不间断工作方式，仍然能保障一定时间一定精度下的称重，不至于造成生产停机。同时仪表会发出信号给用户，定位故障传感器要求更换。
- 模拟传感器系统一旦传感器有故障就无法称重，从而造成停工停产的重大事件。
重量传感器通过测量由重量产生的静压力来确定重量高度，通过LoRaWAN™无线模块将数据上报到网关，用户通过后台系统看到相关数据。[@朱伯申1996数字式传感器]

![数字式称重传感器](https://i.loli.net/2018/10/04/5bb5e337a8854.jpg){#fig:weight_sensor tag="6.1"}

该智能饮水机的数据采集层，主要实现对饮水机中饮用水水桶水量的检测，通过重量传感器进行检测，达到特定重量时响应，并将采集到的信息数据反馈给单片机，通过单片机中数字运算与逻辑比较，判断饮水机水桶剩余水量，以及是否达到临界值，从而决定是否通过 LoRa 模块向服务器发送数据。即，根据所述桶装水的重量计算水桶中的储水剩余量。涉及的硬件有单片机开发板、重量传感器等，可利用重量传感器饮水机中饮用水水桶水量的实时检测。智能饮水机工作流程如{@fig:flowmcu} 所示。

1. 数字式传感器实时检测智能检测水量饮水机中桶装水的重量
2. 单片机根据所述桶装水的重量计算水桶中的储水剩余量
3. 判断所述储水剩余量是否小于预设水量
4. 若所述储水剩余量小于所述预设水量则判定智能检测水量饮水机缺水，则将饮水机的剩余水量通过LoRa模块上行发送；否则结束。

![采集层内部设计流程](https://i.loli.net/2018/10/05/5bb73b7097ead.jpg){#fig:flowmcu tag="6.2"}

上述检测过程依赖于以下条件：，包括:

1. 获取所述水桶的空桶重量；
   - 首次使用时，接通饮水机电源，并放置空水桶通过按键进行初始化；
   - 通过对未装水的所述水桶单独称重以获取所述水桶的空桶重量；并通过用户终端 app 进行初始化

2. 根据所述桶装水的当前重量和所述空桶重量计算所述水桶中的储水重量，并进一步根据所述储水重量计算所述储水剩余量。

综上，饮水机内部数据采集主要模块如{@fig:collect_data_model} ：

- 检测模块，所述检测模块用于实时检测智能检测水量饮水机中桶装水的重量；
- 计算模块，所述计算模块用于根据所述桶装水的重量计算水桶中的储水剩余量；
- 判断模块，所述判断模块用于判断所述储水剩余量是否小于预设水量；
- 判定模块，所述判定模块用于饮水机储水剩余量小于所述预设水量时，判定饮水机缺水，并提交数据给 LoRa 模块。

![饮水机内部数据采集模块工作划分](https://i.loli.net/2018/10/05/5bb641db59a8e.jpg){#fig:collect_data_model tag="6.3"}

## 电路模块
本系统的供电模块主要由三个主要部分构成：家用交流电源，蓄电池、控制器。

当饮水机连接电源时采用家用交流电通过控制器直接为硬件模块供电。当用户断开交流电连接的时候，蓄电池放电保证持续给系统供电。其中控制器对于蓄电池的充放电控制的稳定性非常重要。控制蓄电池工作在浅放电，避免过度充放电将会大大延长蓄电池的使用寿命,从而增加整个系统的寿命。

本系统的供电会有两种工作模式：

- 当用户连接家用交流电时，交流电板给蓄电池和负载同时供电。
- 当未连接交流电源时，蓄电池给负载供电。

本系统采用220V交流电作为系统的直接能源，这样的设计主要考虑到避免用户在使用饮水机时需要处理多部分不同的电源输入，这对于用户是极不友好的。

### 蓄电池

蓄电池是颗粒物浓度监测系统中的供电模块的储能装置，将太阳能电池生成的电能转化为化学能的方式存储起来。当需要蓄电池进行供电时再由化学能转化为电能供电。蓄电池可以支持反复使用、电压稳定、可靠性高、成本低廉。基于蓄电池的诸多优点，被广泛的使用在众多场合。{@tbl:storage_comp} 是市面上常见蓄电池的性能对比：

| 电池类型 | 单体电池电压 | 质量能量密度 | 体积能量密度 | 自放电率 |
|:---------|:-------------|:-------------|:-------------|:---------|
| 铅酸     | 2            | 35           | 60~70        | 2        |
| 镍镉     | 1.2          | 40~50        | 80~125       | 15       |
| 镍氢     | 1.2          | 50~60        | 100~170      | 30       |
| 锂离子   | 3.5          | 140~200      | 300~400      | 1        |

Table: 蓄电池性能对比. {#tbl:storage_comp tag="6.1"}

本系统的蓄电池选择的是锂电池。目前常见蓄电池有铅酸蓄电池，镍钙、镍氢电池等。进行对比得出，锂电池较其他电池有明显优势。根据{@tbl:storage_comp} 可见，锂电池在单位电池电压、质量能量密度、体积能量密度都非常优秀。相同体积下锂电池可以储存更多的能量，同时锂电池的自放电率比较低，并且没有任何的污染物质。基于此选择锂电池作为系统的蓄电池。

### 充放控制电路
在颗粒物浓度监测系统中，供电电源是极为重要的模块。蓄电池的充放电控制技术对供电模块的性能甚至整个饮水机水量检测及发送系统的性能都有非常直接的影响。作为系统的供电模块，一个性能优良的充放电控制电路决定了整个系统的稳定性。充放电控制电路设计了充放电控制、过充过放保护、反流保护、短路保护、反接保护等功能。在放电过程中加以控制可以防止蓄电池过充电及过放。除此之外，太阳能电池板的输入稳定性不好，所以更需要在蓄电池充电过程中进行控制。伏发电系统中对蓄电池充电过程的控制要比普通蓄电池充电过程的控制更复杂些。

## LoRa无线协议栈设计
无线通信模块设计是本系统的关键一环，从传输距离、低功耗和通信可靠性多方面考虑，同吋要兼顾小型化、简便化、可扩展性等因素，本设计最终采用Semtech公司生产的基于LoRa扩频调制技术的低功耗无线射频收发芯片 SX1278。SX1278 可以软件配置内部资源，用户可以根据需求通过编程确定扩频调制带宽（BW）、纠错率（CR）、扩频因子（SF），带宽范围是 7.8~500kHz，扩频因子是 6~12，工作在 ISM 免费频段，中心频点有433MHz、470MHz等，通信距离最远可达五公里。SX1278 还支持标准的FSK、GFSK和 OOK 等调制模式，因此可以与M-BUS系统、IEEE 802.15.4协议等兼容。如{@fig:sx1278_foots} 是 SX1278 的引脚图。

![SX1278 的引脚图](https://i.loli.net/2018/10/16/5bc567cae3df9.jpg){#fig:sx1278_foots tag="6.4"}

| 编号 | 引脚名称   | 引脚说明                    |
|:-----|:-----------|:----------------------------|
| 1    | RFILF      | 信号接收端口                |
| 2    | VRANA      | 模拟电路的稳压电源电压      |
| 3    | VBATANA    | 模拟电路供电输入            |
| 4    | VRDIG      | 数字部分稳压电源电压        |
| 5    | XTA        | 外部晶振接口                |
| 6    | XTB        | 外部晶振接口                |
| 7    | NRESET     | 模块复位                    |
| 8    | DI00       | 中断信号输出                |
| 14   | VBATDIG    | 数字电路供电输入            |
| 16   | SCK        | SPI时钟输入                 |
| 17   | MISO       | SPI数据输出                 |
| 18   | MOSI       | SPI数据输入                 |
| 19   | NSS        | SPI使能信号                 |
| 20   | RXTX/RFMOD | RX/TX开关控制;TX模式为高    |
| 24   | VBATRF     | 射频模块的电源输入          |
| 25   | VRPA       | 用于PA的稳压电源            |
| 27   | PABOOST    | 大功率射频输出,用于发射信号 |

Table: SX1278主要引脚说明. {#tbl:sx1278_foot_tab tag="6.2"}

而SX1278芯片关键核心流程在于无线协议栈发送和接收逻辑。如{@fig:wireless_protocol_process1} 所示，无线数据在发送时，会启动发送流程事件程序，进入流程后首先检测 SX1278 芯片是否空闲，不空闲则在超时后进入复位事件程序停止数据发送，结果发送给网络层，如为空闲则调用 SX1278 芯片冲突回避机制接口进行空中信号检测，若有干扰则再次进入复位事件程序停止数据发送，无干扰则调用 SX1278 芯片的发送接口将数据发送出去[@李善荣2011Si1000;@RonPrice2008无线网络原理与应用]。 无线数据在接收时，模块软件设计流程相对简单，在 SX1278 底层接受到数据时，会触发一个检测帧格式的事件，只对接收到的数据进行数据包格式上的判断，格式正确则回复 ACK 应答帧给网络层进行拆解应用，不正确则丢弃数据[@王瑞2015基于]

![无线协议栈发送流程](https://i.loli.net/2018/10/05/5bb78640ce205.jpg){#fig:wireless_protocol_process1 tag="6.5"}

## 网关到服务器端传输协议设计
通过网关可以实现终端与服务器间的通信，在服务端从网关获取信息，为了能够将不同的消息统一，便于机器的识别与消息格式间的转换，需要设计一个标注的消息格式。经过对现有传感器产品特性的分析以及微环境监测平台中采用的传感器需要传输的属性值归纳，设计比较常见的 JSON 网络传输协议完成网关和服务端之间的通信。

JSON 是一种能够完全不依赖于任何编程语言的文本格式来存储和表示数据的轻量级的数据交换格式[@crockford2006application]。基于 JSON 简洁和清晰的层次结构，JSON 被认为是最佳的数据交换语言。同时 JSON 还具有可阅读性强、编写灵活、易于机器解析和生成等特点，有效地提升网络传输效率。网关与服务器端的 JSON 通信协议需要从数据
采集、设备信息和控制指令三个方面进行设计，分别如{@tbl:margin_data_protocol}、{@tbl:device_info_protocol}、{@tbl:command_protocol} 所示。

| 字段     | 内容                                        |
|:---------|:--------------------------------------------|
| AreaID   | 每一个区域设定一个唯一 ID，以区分不同的地点 |
| UserID   | 每一个用户设定一个唯一 ID，以区分不同的用户 |
| DeviceID | 传感器设备 ID                               |
| Margin   | 由现场控制计算得到的饮水机剩余水量          |
| Warning  | {"01" : "预警", "00":"无预警"}              |
| Time     | 上报时间                                    |
| Check    | 校验和                                      |

Table: 无线检测水量模块数据信息上传协议 {#tbl:margin_data_protocol tag="6.3"}


| 字段       | 内容                                        |
|:-----------|:--------------------------------------------|
| AreaID     | 每一个区域设定一个唯一 ID，以区分不同的地点 |
| DeviceID   | 传感器设备 ID                               |
| DeviceName | 设备名称                                    |
| DeviceType | 设备类型                                    |
| Time       | 上报时间                                    |
| Status     | {“01”: “开”, “02”: “关”, “03”: “故障”}      |
| Check      | 校验和                                      |

Table: 设备信息上传协议  {#tbl:device_info_protocol tag="6.4"}

| 字段     | 内容                                                                |
|:---------|:--------------------------------------------------------------------|
| AreaID   | 设备所属区域 ID                                                     |
| DeviceID | 传感器设备 ID                                                       |
| Time     | 下达时间                                                            |
| Command  | {“01”: ”开”, “02”:“关”, “03”: “索要设备信息”, “04”: “索要采集数据”} |
| Check    | 校验和                                                              |

Table: 设备信息上传协议 {#tbl:command_protocol tag="6.5"}

# 服务器软件设计
应用服务器端开发的主要目的是实现对用户饮水情况的实时监测及为用户提供更便捷的送水服务。本平台可实现对多个监控点统一管理，并具有项目管理、监控管理、查询与预警等功能。应用层主要是设计数据存储处理平台，对感知层设备和采集到的数据进行可视化展示及管理，并直观地为决策者提供告警和决策支持服务[24,25]。

## 需求分析及设计
本平台主要实现对用户信息、项目信息、设备信息的管理，并具有数据查询和警告功能。用户根据自己的需求具有主动申请送水、主动拒绝送水、查询往期饮水情况及预警等权限，可实现对本人信息的查询、管理与决策功能。通过对界面的设计，增强界面的可视化性，方便用户操作。=然间系统的功能模块图如{@fig:sys_module_design}。

- **用户认证** 该模块主要实现用户的注册与登录功能，用户通过输入用户名、密码、手机号等进行注册，注册成功后，输入用户名和密码进行登录。
- **个人中心** 本功能主要包括套餐管理和个人信息管理两大模块。套餐管理模块包括送水套餐的查询与创建。个人信息模块包括用户信息的查询与部分信息的修改。
- **监测管理** 本模块由设备管理、设备控制和监控节点管理组成。设备管理主要是对设备的增加、删除和信息的查看。设备控制主要是对设备下发控制指令，以及设备状态的查看。监控节点管理引入百度地图接口可实现各节点信息的管理，节点内各不同设备部署情况等信息的管理。
- **查询管理** 包括实时环境查询、监测点信息查询和历史数据查询组成，实时查询主要用来显查询处于运行状态的各监测设备所采集的实时值，监测点信息查询主要用来查询各监测点的设备信息和历史数据。
- **报警系统** 主要是对用户饮水机水量达到预警值（无水或预警水量加热）情况，向用户推送预警通知。异常数据报警主要是根据监测数据与标准数据对比，当监测的数据不在标准的数据范围内时，软件端会对该数据所属的传感器给出报警信息，并可以指导用户通过软件端下发控制指令，实现对饮水机的控制，以保证饮水机的安全使用。


![系统功能模块设计](https://i.loli.net/2018/10/16/5bc5ad774c463.jpg){#fig:sys_module_design tag="7.1"}

## 软件架构设计
该系统可以允许多个用户在多地进行访问，面对庞大的用户以及大量的数据，该系统的软件设计的实现采用 B/S 架构体系，通过HTTP协议传输数据，功能界面主要通过浏览器和微信APP实现，简化前端的事务逻辑，核心功能集中到服务器上，简化平台的开发。采用 B/S 结构将 MySQL数据库与应用程序安装在服务器上，用户端不用复杂的操作，仅仅通过一个浏览器或APP就可以快速实现对平台的数据访问和管理等。

本平台的软件端结构分为表示层、业务逻辑层和数据层三个层次，其设计原理如{@fig:sys_struct_design} 所示。各层功能如下。


![系统软件结构设计
](https://i.loli.net/2018/10/16/5bc5b1d0d0549.jpg){#fig:sys_struct_design tag="7.2"}

- **展示层** 主要是实现前后台的交互，实现对数据的可视化展示，以及对用户的操作进行分析。即浏览器或APP。
- 业务逻辑层是信息双向传递的桥梁，用户发起请求或水量预警时，请求信息首先传送到本层，本层对请求进行分析与处理后，按照用户请求访问数据库，并将结果通过本层传递到展示层。即服务器程序。
- 数据层是本结构的数据基础，实现对其他层的数据支持。即MySQL数据库。

业务逻辑层，应用服务器。它是基于B/S架构、HTTP协议编写的PC端应用程序。该程序实现方案有多种，该系统采用非常成熟的、面向对象的Java语言，由于该语言长期被用于编写企业级服务器，已经涌现出一大批的成熟的开发框架（如Tomcat容器，Spring Frameworks等），且其处理海量数据方面抗压能力及其跨平台性，可以在较短的时内实现一个高效、稳定的Server端程序。其工作可以概括为两部分：判断由LoRa发送的数据并通知用户预约送水时间；根据用户的反馈，预约时间，响应时间进行数据分析进而为用户提供更贴切的服务。

展示层，即浏览器及APP。在当前的前后端分离的开发思想影响下，服务器端已不再完全与前端应用捆绑，前后端仅涉及数据的交互。而JSON[@crockford2006application]数据格式也完全符合该软件的设计思想。因此我们完全可以实现一个后端服务器而拥有多个前端APP。由于 WebApp 开发经过十多年的发展，也拥有一大批的优秀的开发框架，如快速构建页面的Bootstrap，方便 DOM 操作的JQuery，处理数据的 Vue等等。这也使得WebApp更易于开发。而随着微信小程序的兴起，移动端开发APP也变得更加简单。微信小程序提供给开发者一整套的接口，以及常用的界面布局控件，可以让我们快速的开发出符合需求的APP。

## 数据库设计
为了能够将系统所需要的数据有结构、有条理进行存储及管理，需要慎重地对数据库进行设计。数据库在系统中的作用可以比拟为心脏在人体的作用，有着极为重要的意义。扼要地对数据库的功能进行分析，就是实现对数据的存储和处理。在本平台中，数据库的作用首先是存储饮水机中传感器检测、通过 LoRa 技术上传的水量数据，以便在平台需要时，数据库可以提供相应的数据。其次，数据库还可以实现对系统软件端下发的控制指令等其他数据的存储和读取。通过对本软件的需求、数据间的联系和每个数据属性的分析，设计与实现本系统所需的数据表，主要有用户表、套餐表、用户套餐关系表、区域表、节点表、传感器表。下面对这些表的主要属性进行陈列及说明。

### 用户的认证与授权（系统的安全）
该系统设计用户交易操作，故系统安全更是重中之重。该系统设计采用基于角色的访问控制（Role-Based Access Control，RBAC）控制用户访问权限。在RBAC中，权限与角色相关联，用户通过成为适当角色的成员而得到这些角色的权限。这就极大地简化了权限的管理。在一个组织中，角色是为了完成各种工作而创造，用户则依据它的责任和资格来被指派相应的角色，用户可以很容易地从一个角色被指派到另一个角色。角色可依新的需求和系统的合并而赋予新的权限，而权限也可根据需要而从某角色中回收。角色与角色的关系可以建立起来以囊括更广泛的客观情况。[@ferraiolo1995role]

通用的 RBAC 数据模型， 一般需要五张表（三张实体表，两张关系表）。三张实体表包括用户表、角色表、资源表。两张关系表包括。其之间关系如{@fig:rbac_model} ：

![RBAC数据模型](http://upload-images.jianshu.io/upload_images/5464539-bbf88cad3343943e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/686){#fig:rbac_model tag="7.3"}

**用户表（lora_user）**
通过设计用户表的子段名、数据类型等，建立用户表，用于存储用户的基本信息（见{@tbl:table_lora_user} ），为系统的实现提供用户信息。

| 编号 | 字段名称      | 数据类型    | 允许空 | 说明                               |
|:-----|:--------------|:------------|:-------|:-----------------------------------|
| 1    | id            | int(16)     | 否     | ID，自增，主键                     |
| 2    | username      | varchar(12) | 否     | 用户名                             |
| 3    | password      | char(16)    | 否     | 密码                               |
| 4    | tel           | varchar(13) | 是     | 电话                               |
| 5    | register_date | datetime    | 是     | 注册时间，默认值:CURRENT_TIMESTAMP |
| 6    | emial         | varchar(50) | 否     | 邮箱                               |
| 7    | wechat        | varchar(30) | 是     | 微信账号                           |
| 8    | balance       | float(7,2)  | 否     | 账户余额，精确到分（0~99999.99）   |
| 9    | area_id       | int(16)     | 否     | 区域表主键                         |
| 10   | status        | tinyint     | 否     | 该用户是否有效                     |

Table: 用户表字段设计 {#tbl:table_lora_user tag="7.1"}

**角色表（lora_character）**
一个完整的系统必然包含多种用户，而这种类便成为“角色”。例如，在该系统中，普通消费者作为普通用户，而拥有管理权限的用户又包括了系统维护开发人员、业务人员、决策发布者等（见{@tbl:table_lora_character} ）。

| 编号 | 字段名称 | 数据类型    | 允许空 | 说明           |
|:-----|:---------|:------------|:-------|:---------------|
| 1    | id       | int(16)     | 否     | 自增，主键     |
| 2    | name     | varchar(22) | 否     | 角色没名称     |
| 3    | status   | tinyint     | 否     | 状态，是否有效 |
Table: 系统角色表字段设计 {#tbl:table_lora_character tag="7.2"}

**资源表（lora_resource）**
每种不同的角色的权限是通过其可以访问的资源决定的。系统的软件端通过HTTP协议进行数据交互，那么访问的URL便是资源，若是以WebApp为例，其页面上的每一个控件都是资源(见{@tbl:table_lora_resource} )。很明显，这张表是由开发运营人员维护的。

| 编号 | 字段名称 | 数据类型     | 允许空 | 说明           |
|:-----|:---------|:-------------|:-------|:---------------|
| 1    | id       | int(16)      | 否     | 自增，主键     |
| 2    | name     | varchar(50)  | 是     | 资源名称       |
| 3    | resource | varchar(125) | 是     | 资源           |
| 4    | status   | tinyint      | 否     | 状态，是否可用 |
Table: 系统资源表字段设计 {#tbl:table_lora_resource tag="7.3"}

**用户-角色关系表（lora_user_character）**
哪些用户具备哪些角色，一个用户可以具备多个角色，而一个角色也可以被多个用户所扮演，这是一个多对多的关系（见{@tbl:table_lora_user_character} ）。

| 编号 | 字段名称     | 数据类型 | 允许空 | 说明       |
|:-----|:-------------|:---------|:-------|:-----------|
| 1    | id           | int(16)  | 否     | 自增，主键 |
| 2    | user_id      | int(16)  | 否     | 用户ID     |
| 3    | character_id | int(16)  | 否     | 角色ID     |
Table: 系统用户角色关系表表字段设计 {#tbl:table_lora_user_character tag="7.4"}

**角色-资源关系表（lora_character_resource）**
每种不同的角色只能访问限定的几种资源，而一种资源又被多个角色所访问。这样一来，拥有多个角色的用户，（见{@tbl:table_lora_character_resource} ）自然可以访问多种资源，从而组成了多对多的关系。

| 编号 | 字段名称     | 数据类型 | 允许空 | 说明       |
|:-----|:-------------|:---------|:-------|:-----------|
| 1    | id           | int(16)  | 否     | 自增，主键 |
| 2    | character_id | int(16)  | 否     | 角色ID     |
| 3    | resource_id  | int(16)  | 否     | 资源ID     |
Table: 系统角色-资源关系表字段设计 {#tbl:table_lora_character_resource tag="7.5"}

### 套餐表（lora_package）
为了方便用户选购送水方式及送水频率，系统会根据用户的主管要求为用户提供多样的套餐，以应对多样的送水需求。另外，系统会根据用户以往的需水数据为用户推荐最适合的送水套餐，而套餐表（见{@tbl:table_lora_package} ）用与存储系统所设定的套餐数据。

| 编号 | 字段名称    | 数据类型     | 允许空 | 说明                                |
|:-----|:------------|:-------------|:-------|:------------------------------------|
| 1    | id          | int(16)      | 否     | 套餐编号，自增，主键                |
| 2    | name        | varchar(20)  | 否     | 套餐名称                            |
| 3    | intro       | varchar(100) | 是     | 套餐简介                            |
| 4    | create_date | datetime     | 是     | 创建时间，默认值：CURRENT_TIMESTAMP |
| 5    | price       | float(6,2)   | 否     | 套餐价格                            |
| 6    | status      | tinyint      | 否     | 该套餐是否可订购                    |

Table: 套餐表字段设计 {#tbl:table_lora_package tag="7.6"}

### 区域表（lora_area）
为了更方便地处理、收集不同区域的用户饮水数据，同时原为了照顾LoRa传输的范围限制，系统需要将用户划分在不同的区域，而区域表（见{@tbl:table_lora_area} ）用于存储区域划分信息。

| 编号 | 字段名称  | 数据类型     | 允许空 | 说明           |
|:-----|:----------|:-------------|:-------|:---------------|
| 1    | id        | int(16)      | 否     | 区域编号       |
| 2    | type      | varchar(10)  | 是     | 区域类型       |
| 3    | name      | varchar(20)  | 是     | 区域名称       |
| 4    | image     | varchar(100) | 是     | 区域照片       |
| 5    | intro     | varchar(200) | 是     | 区域描述       |
| 6    | date      | datetime     | 是     | 布控时间       |
| 7    | status    | varchar(3)   | 否     | 区域状态       |
| 8    | usr_count | int(16)      | 否     | 该区域用户数   |
| 10   | status    | tinyint      | 否     | 该区域是否可用 |
Table: 区域表字段设计 {#tbl:table_lora_area tag="7.7"}

### 用户套餐关系表（lora_user_package）
为了实时查询用户订购的送水套餐情况（当前与历史），需要构造该表（见{@tbl:table_lora_user_package} ）存储用户的购买记录。

| 编号 | 字段名称   | 数据类型 | 允许空 | 说明                                   |
|:-----|:-----------|:---------|:-------|:---------------------------------------|
| 1    | id         | int(16)  | 否     | 主键，自增                             |
| 2    | user_id    | int(16)  | 否     | 用户ID                                 |
| 3    | package_id | int(16)  | 否     | 套餐ID                                 |
| 4    | oder_date  | datetime | 是     | 订购套餐时间，默认值:CURRENT_TIMESTAMP |
| 5    | end_date   | datetime | 是     | 套餐到期时间                           |
| 6    | status     | tinyint  | 否     | 该行数据是否有效                       |
Table:用户套餐关系表字段设计 {#tbl:table_lora_user_package tag="7.8"}

# 测试分析设计
为了验证平台的可靠性，本方案在参考了大量国内外研究现状的基础上，设计出一套实验验证本课题的可靠性，对多种类型数据采集的可行性、数据传输的丢包率与延时等多种参数进行分析实验验证。

## 实验方案设计

### 外界实验环境选择
为了使实验结果更具有说服力，本测试需要分别在实验室及模拟城市环境中进行多次测试。在实验过程中，为保证测试数据的可靠性，尽量减少外界环境的干扰，选择了相对天气晴朗的环境进行了实验，降低了雷雨天气等外界因素对网络传输的影响程度。根据 LoRa 无线传输特点与业务需求，选取障碍物适量，建筑物较多的环境，在不同网络类型和实验可用网络资源量的情况下进行实验。

### 网络实验环境设计
本设计需选用的局域网在实验室环境下进行了测试实验，并使用 20M 带宽的外网对模拟的城市环境进行了测试。为增强实验的准确性，本文在局域网和外网的测试过程中分别按照该平台可利用网络占整个网络的 90%、70%、50%和 30%情况进行了测试。

在局域网搭建工作中，实验需要选用 4 台计算机通过一个路由器组建了一个小型局域网。该路由器具有有线和无线两种接入方式，接入的 4 台计算机一台用作上位机，一台用作服务端，提供 Web 服务，另外两台计算机可通过互相传输数据实现对该局域网网络资源的占用，使上位机与服务端在可用网络资源不同的情况下进行实验测试。在外网的测试实验中，本文分别选用了 20M 的网络作为实验所用网络，并通过其他程序分别占用不同的网络带宽，使该实验可用网络分别为 20M、15M、10M 和5M。
## 平台性能测试

### 数据传输可靠性测试
在实验进行之前，应关闭系统中所有与本实验无关的程序（包括上位机、服务器以及局域网中另外两台计算机），减少对实验的干扰。在局域网环境中测试时，首先让上位机和服务端程序占用整个局域网，即接入该局域网的另外两台不做任何操作，然后再让另外两台计算机间在该局域网下进行 http 通信，通过调整这两台电脑发送的字节数及发送周期改变他们在该局域网中所占用的网络资源量，从而实现在不同网络资源下的实验。在外网的测试实验中，同样首先关闭上位机和服务端与本实验无关的所有程序，减少对实验的干扰，然后通过打开一些小型网络程序实现
对网络资源的占用，完成分别为 20M、15M、10M 和 5M 外网情况下的实验。

### 数据延时测试
对数据的延时进行测试时，由于数据传输速度较快，测试距离较短，测试过程中忽略了信号在传输过程中所用的时间。上位机发送指令时，首先网关被唤醒，网关被唤醒后返回上位机信息“OK”，网关唤醒后，网关唤醒终端，终端被唤醒后，向网关返回“唤醒”信息，终端被唤醒后向上位机返回数据，显示上位机“主动”下发命令，此时，从上位机发送控制指令到反馈给上位机终端已响应的过程结束。

### 控制命令可靠性测试
本系统可通过用户下发控制指令实现对传感器的控制，为提高平台的可用性，本文需对用户下方的控制指令后传感器的接收和响应情况进行测试，测试过程中用户所下发的控制指令包括开启设备、关闭设备、索要设备状态信息和索要数据信息，每种控制指令需进行多次实验。

# 心得体会
通过该课程，我首先学会了撰写科技论文。科技论文是由科技工作者对其创造性研究成果进行理论分析和科学总结，并得以公开发表或通过答辩的科技写作文体，一篇完备的科技论文，应该按一定的格式书写，并具有科学性、首创性和逻辑性；还应按一定的方式发表，即有效出版。科技论文的类型一般有论证型、科技报告型、发现发明型、计算型和综述型五种。作为科技报告型论文要求有作者自己的新见解，应提供所研究项目足够的信息，写出的原始资料必须准确，可以包括正反两方面的经验和结果，使之成为进一步研究的依据。一篇好的综述型论文应包含有前人未曾发表过的新思想和新资料，还要求撰写者在综合分析和评价已有资料的基础上，提出特定时期内有关学科或专业领域的演变规律和发展趋势。写论文要避免使用含义笼统及一般化的词语;还应避免用不得体的华丽词藻，或过高过低的程度用语。国内的科技期刊要求论文题名的用字不超过20个汉字，外文题名不超过10个实词。另外题名中应尽量避免使用化学结构式、数学公式、不太为同行熟悉的外来语、符号、简称、缩写以及商品名称。

大学生科研训练这门课还让我意识到，自己对本专业的发展现状及重大的科研成果没有多少认知，计算机是发展十分迅速更新换代非常快的行业，掌握其最新的科研信息非常重要，所以我们只浅显的学到学校要求的专业知识是远远不够的，这就需要我们有较强的自主学习的能力要跟上科技时代的发展，自己在今后的学习生活中会积极了解有关本专业的前沿科技信息，自主学习本专业相关技术软件的应用并积极培养自主常新的能力。

通过大学生科研训练这门课程，让我发觉自己在大学期间的发展目标并不明确，我们在学校学的知识并不是全能的，有很多知识我们都不知道干什么的时候能用的，理论知识只是单纯的理论没有实际意义，在问题面前总是无从下手。所以通过此课程的学习让我认识到理论与实际联系的重要性。一篇看似简单的论文不是想象中那么简单，高质量的论文不是想写就写出来的，包含着作者辛勤的劳动、汗水、心血和智慧。通过长时期实验，精心观察，准确的数据处理，完美的表达，才有一篇高水平论文的面世。“一分耕耘，一分收获”每个人只有勤奋刻苦努力，经过长时间磨练，才能写出高质量的论文。学习专业知识亦是如此，不经过认真努力永远没有好的发展，我们做人又何尝不是呢!

# 参考文献
